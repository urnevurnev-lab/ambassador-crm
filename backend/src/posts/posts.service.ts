import { Injectable, OnModuleInit } from '@nestjs/common';
import { PrismaService } from '../prisma.service';

@Injectable()
export class PostsService implements OnModuleInit {
    constructor(private prisma: PrismaService) { }

    async onModuleInit() {
        // Seed Knowledge Base if empty
        const count = await this.prisma.post.count({ where: { category: 'KNOWLEDGE' } });
        if (count === 0) {
            await this.seedKnowledgeBase();
        }
    }

    async findAll(category?: string) {
        return this.prisma.post.findMany({
            where: category ? { category } : {},
            orderBy: { importance: 'desc' }
        });
    }

    async findOne(id: number) {
        return this.prisma.post.findUnique({ where: { id } });
    }

    private async seedKnowledgeBase() {
        const text = `# База знаний: Бренд NAШ & BLISS

## 1. История и Философия Бренда

### Истоки и Нейминг
* **Корни:** Компания берет начало в 2013 году от бренда угля **OASIS**.
* **Запуск NAШ:** Как табачный бренд мы стартовали в 2019 году, а официальная презентация состоялась в 2020 году на Hookah Club Show (формат слепой дегустации).
* **Название:** Родилось из рабочего сленга («Как назовем НАШ продукт?»). Времени было мало, вариант утвердили как самый простой и родной.
* **Ребрендинг 2025:** В портфеле компании произошло обновление названий линеек: «Классическая» стала **White Line**, а «Hard» превратилась в **Black Line**.

### Философия: «Крепкий, но мягкий»
Это ключевой принцип курения нашего продукта.
* **Суть:** Продукт не должен «убивать» со старта. Это плавное, спокойное курение, где насыщение никотином происходит равномерно в течение всей сессии.
* **Цель:** Создать универсальный продукт, работающий на любых чашах, простой и понятный в работе.

---

## 2. Архитектура Продукта (Линейки)

На 2025 год портфель состоит из 2 брендов и 4 линеек:

### BLISS (Легкий сегмент)
Отдельный дочерний бренд, ориентированный на HoReCa и мастеров.
* **Сырье:** 100% Польская Вирджиния («вымытая»).
* **Крепость:** Легкая (0.1–0.2% никотина).
* **Особенности:** Нет привкуса табачного сырья, держит высокие температуры, стартует без задержек.
* **Фасовка:** 40г, 100г, 250г.

### NAШ White Line (ex-Классика)
Средний сегмент, «рабочая лошадка».
* **Сырье:** Бленд из Польской Вирджинии (филлер) и Польского Берли (основа). Пропорция ~90% Вирджиния / 10% Берли.
* **Крепость:** Средняя (2.0% никотина).
* **Особенности:** Мягкость, сладковатый вкус, высокая жаростойкость.
* **Фасовка:** 20г, 40г, 100г, 200г.

### NAШ Black Line (ex-Hard)
Крепкий продукт для тех, кому нужно больше.
* **Сырье:** Преимущественно Берли (до 100% в старой версии, сейчас баланс для комфорта).
* **Крепость:** Высокая (2.7% никотина).
* **Особенности:** Ощутимое никотиновое давление на легкие без жесткого удара по горлу (ТХ). Ароматы могут ощущаться чуть кислее из-за специфики сырья.
* **Фасовка:** 20г, 100г, 200г.

### NAШ Cigar Line
Доступная точка входа в мир сигарного табака.
* **Сырье:** Бленд листьев из Бразилии, Малави и Индонезии (ферментированные листы черной группы).
* **Крепость:** Около 3.7%.
* **Технология:** Лист проходит сушку DAC (Dark Air Cured).
* **Особенность:** Ароматика дополняет вкус листа, а не перебивает его. Есть позиция «База» (без аромки).

---

## 3. Технология Производства

### NAШ (White & Black)
Классическая варка для получения насыщенного вкуса.
1.  **Варка (2 часа):** Табак увлажняется, загружается в котел с сиропом и глицерином при высокой температуре.
2.  **Сироп:** Мед (натуральная сладость) + Сахарный колер (сглаживает табачный привкус).
3.  **Настойка:** После остывания добавляются ароматизаторы, продукт настаивается 4 дня.

### BLISS
Технология «вымывания» для легкости.
1.  **Вываривание:** Лист варится в воде для удаления никотина и вкуса сырья, затем сушится.
2.  **Увлажнение:** Сухой лист увлажняют глицерином для лучшей впитываемости.
3.  **Сироп:** Мед + Сукралоза (подсластитель). Настаивается в тепловой комнате (40°C) 4 дня.

---

## 4. Теория: Химия Никотина и Организм

### Формы Никотина
Понимание pH (кислотно-щелочного баланса) критично для понимания крепости.
* **Протонированный (солевой):** При низком pH (<3.0). Усваивается медленно.
* **Свободный (летучий):** При высоком pH (>8). Легко проникает через мембраны, дает быстрый эффект («накуривает» быстрее).
* *Практика:* Сигареты — щелочные (быстрый удар), сигары/трубки — более кислые (впитывание через слизистую рта).

### Влияние на Нервную Систему
Никотин имитирует ацетилхолин, воздействуя на вегетативную нервную систему:
1.  **Симпатическая система (Тонус):** Учащается пульс, активность. Если гость активен — контролируйте жар, чтобы не перегреть.
2.  **Парасимпатическая система (Расслабление):** Снижение пульса, расслабление. Если гостя «размазало» — снизьте жар, дайте воды/сахара, проветрите.

---

## 5. Практическое Руководство (FAQ и Работа)

### Крепость vs Жесткость
Это разные понятия, которые часто путают.
* **Крепость:** Количество никотина в листе (объективный показатель).
* **Жесткость:** Интенсивность испарения компонентов (ТХ, першение). Зависит от аромки (кислые/цитрусовые кажутся жестче), перегрева сахара или избытка глицерина.

### Рекомендации по Забивке
Продукт универсален, но результат зависит от чаши:
* **Фаннел (Phunnel):** Для первого знакомства. Пушистая укладка. Если курите активно — легкое касание; если спокойно — отступ.
* **Турка (Прямоток):** Классика. Пушисто. Можно сделать «колодец» для легкости. Касание даст больше аромки и крепости сразу.
* **Убивашка (Flat bottom):** Чтобы выжать максимум крепости за счет плоского дна и прогрева. Будет куриться жестче.

### Частые вопросы (FAQ)
1.  **«Почему нужно греть дольше?»** — Крупная нарезка и сахарный сироп требуют глубокого прогрева. Это обеспечивает долгую работу в миксах.
2.  **«Почему встречаются палки?»** — В больших фасовках (ручная фасовка) возможен человеческий фактор. В мелких (автомат) — лопасти могут менять консистенцию.
3.  **«Как продлить курение?»** — Лист хорошо впитывает сироп. При правильном прогреве смесь отдает вкус 40–60 минут.`;

        await this.prisma.post.create({
            data: {
                title: 'Бренд NAШ & BLISS: Полный Гайд',
                category: 'KNOWLEDGE',
                readTime: '15 мин',
                content: text,
                imageUrl: 'https://i.imgur.com/example.jpg', // Placeholder or upload
                importance: 10
            }
        });
        console.log('Knowledge Base seeded!');
    }
}
